---
title: "Spatial Data"
format: html
editor: visual
---

```{r}
#| include: false
library(readr)
library(here)
library(sf)
library(ggplot2)
library(leaflet)
library(scales)
library(ggspatial)
library(dplyr)
```

# Loading Data

```{r}
knb_url <- "https://dev.nceas.ucsb.edu/knb/d1/mn/v2/object/urn%3Auuid%3Aaceaecb2-1ce0-4d41-a839-d3607d32bb58"

download.file(url = knb_url, destfile = here('shapefile_demo_data.zip'))

unzip(here('shapefile_demo_data.zip'), exdir = here('data'))

file.remove(here('shapefile_demo_data.zip'))
```

# Exploring data with plot() and st_crs()

```{r}
 # read in shapefile using read_sf()

ak_rgns_sf <- read_sf(here("data/ak_regions_simp.shp"))

plot(ak_rgns_sf)

class(ak_rgns_sf)

head(ak_rgns_sf)

glimpse(ak_rgns_sf)
```

## st_crs() to get a crs

```{r}
st_crs(ak_rgns_sf)
```

## st_transform() to transform the crs

```{r}
ak_rgns_3338_sf <- ak_rgns_sf %>%
  st_transform(crs = 3338)

st_crs(ak_rgns_3338_sf)

plot(ak_rgns_3338_sf)
```

## filter()
```{r}
#get values in region colmn
unique(ak_rgns_3338_sf$region)

ak_rgns_3338_sf %>%
  filter(region == "Southeast")
```

## select()
```{r}
colnames(ak_rgns_3338_sf)

ak_rgns_3338_sf %>%
  select(region)
```

# Spatial joins 

## read in new data
```{r}
pop_df <-  read_csv(here("data/alaska_population.csv"))

head(pop_df)
```

## convert data frame to a spatial object
```{r}
pop_4326_sf <- st_as_sf(pop_df,
                        coords = c('lng', 'lat'),
                        crs = 4326, 
                        remove = F) 

head(pop_4326_sf)
```

## joining data with st_join
```{r}
#pop_join_sf <- st_join(pop_4326_sf,
#                       ak_rgns_3338_sf,
#                      join = st_within)

# transform the pop data
pop_3338_sf <- st_transform(pop_4326_sf,
                            crs = 3338)

pop_join_sf <- st_join(pop_3338_sf,
                      ak_rgns_3338_sf,
                     join = st_within)

head(pop_join_sf)
```

## calculate total population using group_by() and summarize()
```{r}
pop_rgn_df <- pop_join_sf %>%
  st_drop_geometry() %>%
  group_by(region) %>%
  summarize(total_pop = sum(population))

head(pop_rgn_df)
```

## left_join() to merge back into spatial object
```{r}
pop_rgn_3338_sf <- left_join(ak_rgns_3338_sf, pop_rgn_df, by = "region")

head(pop_rgn_3338_sf)
```

## plot population by management area 
```{r}
pop_mgmt_3338_sf_bad <- pop_rgn_3338_sf %>%
  group_by(mgmt_area) %>%
  summarize(total_pop = sum(total_pop), do_union = T)

plot(pop_mgmt_3338_sf_bad["total_pop"])
```

```{r}
pop_mgmt_3338_sf <- pop_rgn_3338_sf %>%
  group_by(mgmt_area) %>%
  summarize(total_pop = sum(total_pop), do_union = F)

plot(pop_mgmt_3338_sf["total_pop"])
```

## save the sf object with write_sf()
```{r}
write_sf(pop_rgn_3338_sf,
         here("data/ak_region_population.shp"))

```

